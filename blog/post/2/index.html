<!DOCTYPE html><html lang="en"><head>
  <meta charset="utf-8">
  <title>How to prevent calling api twice when using Angular Universal?</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noarchive">

  <!--google search console-->
  <meta name="google-site-verification" content="FvJr6-VJwBRr0W2f2KsCq9l6yjCc-pz34H2DfQvuapI">

  <!--naver webmaster tool-->
  <meta name="naver-site-verification" content="a71aa01a61cb84dee7b2c0633ef7dc6d333b0a1c">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-L0FBKJKZ1D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-L0FBKJKZ1D');
  </script>

  <!-- SEO tags -->
  <!-- default -->
  <meta name="author" content="tk2rush90">
  <meta name="description" content="The Angular provides powerful support for Server-Side Rendering with Angular Universal. But when getting some data via HTTP Client, I noticed that the page calls API twice from the server and browser. This is the solution to prevent this weirdness.PrerequisiteAngular2+. I used Angular 13.2.0Angular ">
  <meta name="keywords" itemprop="keywords" content="Angular, Angular Universal, Http, SSR, Server Side Rendering, twice, api">
  <!-- twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="How to prevent calling api twice when using Angular Universal?">
  <meta name="twitter:description" content="The Angular provides powerful support for Server-Side Rendering with Angular Universal. But when getting some data via HTTP Client, I noticed that the page calls API twice from the server and browser. This is the solution to prevent this weirdness.PrerequisiteAngular2+. I used Angular 13.2.0Angular ">
  <meta name="twitter:image:src" content="/assets/images/posts/2/thumbnail.png?v=qqithqu6ut8">
  <meta name="twitter:image" content="/assets/images/posts/2/thumbnail.png?v=qqithqu6ut8">
  <meta name="twitter:url" content="https://tk2blog90.github.io/blog/post/2">
  <!-- opengraph -->
  <meta property="og:title" content="How to prevent calling api twice when using Angular Universal?">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://tk2blog90.github.io/blog/post/2">
  <meta property="og:image" content="/assets/images/posts/2/thumbnail.png?v=qqithqu6ut8">
  <meta property="og:description" content="The Angular provides powerful support for Server-Side Rendering with Angular Universal. But when getting some data via HTTP Client, I noticed that the page calls API twice from the server and browser. This is the solution to prevent this weirdness.PrerequisiteAngular2+. I used Angular 13.2.0Angular ">
  <meta property="og:site_name" content="LOGLOG">
  <meta property="og:locale" content="">

  <!-- favicons -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/app/apple-icon-57x57.png?v=1234">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/app/apple-icon-60x60.png?v=1234">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/app/apple-icon-72x72.png?v=1234">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/app/apple-icon-76x76.png?v=1234">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/app/apple-icon-114x114.png?v=1234">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/app/apple-icon-120x120.png?v=1234">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/app/apple-icon-144x144.png?v=1234">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/app/apple-icon-152x152.png?v=1234">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/app/apple-icon-180x180.png?v=1234">
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/images/app/android-icon-192x192.png?v=1234">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/app/favicon-32x32.png?v=1234">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/images/app/favicon-96x96.png?v=1234">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/app/favicon-16x16.png?v=1234">
  <link rel="manifest" href="/assets/images/app/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/images/app/ms-icon-144x144.png?v=1234">
  <meta name="theme-color" content="#ffffff">
<style>@import"https://fonts.googleapis.com/css2?family=Gothic+A1:wght@100;200;300;400;500;600;700;800;900&family=JetBrains+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap";*{padding:0;margin:0}*{transition:background-color .15s,fill .15s;-webkit-tap-highlight-color:transparent}</style><style>@import"https://fonts.googleapis.com/css2?family=Gothic+A1:wght@100;200;300;400;500;600;700;800;900&family=JetBrains+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap";*{padding:0;margin:0}a{text-decoration:none;color:inherit}.tk-ripple-container{position:relative}.tk-ripple-container.tk-ripple-bounded{overflow:hidden}.theme-light .grey-text{color:#0000004d}.theme-light app-copyrights{color:#333}.theme-light markdown h1:before,.theme-light markdown h2:before{color:#3333334d}.theme-light .image-placeholder{background-color:#3333330d}.theme-light app-header{background-color:#fff}markdown *{-webkit-user-select:auto;user-select:auto}markdown h1,markdown h2{margin:2em 0;font-weight:600;word-break:break-word}markdown h1:before,markdown h2:before{content:"#";height:1em;display:inline-block;vertical-align:baseline;margin-right:5px}markdown h1{font-size:26px}markdown h2{font-size:24px}markdown p{margin:2em 0;line-height:1.8em}markdown code{font-family:JetBrains Mono,monospace;font-size:13px;font-weight:400;color:#41c2de}markdown ul{margin:2em 0}markdown li{line-height:1.8em}markdown ul>li{list-style-type:none}markdown ul>li:before{content:"-";margin-right:5px;display:inline-block;vertical-align:middle;margin-top:-3px}markdown>ul{padding-left:0}markdown a{color:#41c2de;text-decoration:underline}markdown a:hover{color:#6cd0e6}code[class*=language-]{color:#000;background:none;text-shadow:0 1px white;font-family:JetBrains Mono,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:12px;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.8em;tab-size:4;-webkit-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-]{text-shadow:none}}*{transition:background-color .15s,fill .15s;-webkit-tap-highlight-color:transparent}img{display:block}</style><link rel="stylesheet" href="styles.d127e55db5ca2b89.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles.d127e55db5ca2b89.css"></noscript><style ng-transition="serverApp">[_nghost-sc75]{width:100%;height:100%;position:absolute;display:block;font-family:Montserrat,Gothic A1,sans-serif;font-size:14px}.theme-light[_nghost-sc75]{background-color:#fff;color:#333}.theme-dark[_nghost-sc75]{background-color:#333;color:#fff}[_nghost-sc75]     app-home+app-home, [_nghost-sc75]     app-home+app-blog, [_nghost-sc75]     app-blog+app-home, [_nghost-sc75]     app-blog+app-blog{position:absolute;width:100%;top:0}[_nghost-sc75]     app-home+app-home, [_nghost-sc75]     app-home+app-not-found, [_nghost-sc75]     app-not-found+app-home, [_nghost-sc75]     app-not-found+app-not-found{position:absolute;width:100%;top:0}[_nghost-sc75]     app-blog+app-blog, [_nghost-sc75]     app-blog+app-not-found, [_nghost-sc75]     app-not-found+app-blog, [_nghost-sc75]     app-not-found+app-not-found{position:absolute;width:100%;top:0}</style><style ng-transition="serverApp"></style><style ng-transition="serverApp">[_nghost-sc25]{width:100%;height:100%;display:block;overflow:auto}main[_ngcontent-sc25]{max-width:1000px;width:calc(100% - 20px);margin:0 auto}app-header[_ngcontent-sc25]{z-index:100}app-header.scrollable[_ngcontent-sc25]{position:sticky;top:0;height:50px;opacity:0;transition:opacity .1s;box-shadow:0 3px 6px #0000004d;pointer-events:none}app-header.scrollable.scrolled[_ngcontent-sc25]{opacity:1;pointer-events:auto}.container[_ngcontent-sc25]{position:relative}[_nghost-sc25]     app-list+app-list, [_nghost-sc25]     app-list+app-post, [_nghost-sc25]     app-post+app-list, [_nghost-sc25]     app-post+app-post{position:absolute;width:100%;top:0}[_nghost-sc25]     app-list+app-list, [_nghost-sc25]     app-list+app-search, [_nghost-sc25]     app-search+app-list, [_nghost-sc25]     app-search+app-search{position:absolute;width:100%;top:0}[_nghost-sc25]     app-list+app-list, [_nghost-sc25]     app-list+app-tags, [_nghost-sc25]     app-tags+app-list, [_nghost-sc25]     app-tags+app-tags{position:absolute;width:100%;top:0}[_nghost-sc25]     app-post+app-post, [_nghost-sc25]     app-post+app-search, [_nghost-sc25]     app-search+app-post, [_nghost-sc25]     app-search+app-search{position:absolute;width:100%;top:0}[_nghost-sc25]     app-post+app-post, [_nghost-sc25]     app-post+app-tags, [_nghost-sc25]     app-tags+app-post, [_nghost-sc25]     app-tags+app-tags{position:absolute;width:100%;top:0}[_nghost-sc25]     app-search+app-search, [_nghost-sc25]     app-search+app-tags, [_nghost-sc25]     app-tags+app-search, [_nghost-sc25]     app-tags+app-tags{position:absolute;width:100%;top:0}</style><style ng-transition="serverApp">[_nghost-sc24]{display:block;-webkit-user-select:none;user-select:none;height:150px}.container[_ngcontent-sc24]{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;max-width:1000px;width:calc(100% - 20px);height:100%;margin:0 auto}.container[_ngcontent-sc24] > *[_ngcontent-sc24]{flex:0 0 auto}.title[_ngcontent-sc24]{font-weight:900;font-size:30px;color:#41c2de}.buttons[_ngcontent-sc24]{display:flex;align-items:center;flex-wrap:wrap}.buttons[_ngcontent-sc24] > *[_ngcontent-sc24]{flex:0 0 auto}.search[_ngcontent-sc24]{margin-left:10px}</style><style ng-transition="serverApp">[_nghost-sc21]{cursor:pointer;display:block}</style><style ng-transition="serverApp">[_nghost-sc19]{display:block}[_nghost-sc19]     svg{display:block}</style><style ng-transition="serverApp">[_nghost-sc71]{position:relative;display:block}.container[_ngcontent-sc71]{max-width:600px;width:100%;margin:0 auto}.meta[_ngcontent-sc71]{display:flex;align-items:center;flex-direction:column;flex-wrap:wrap;text-align:center}.meta[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}.title[_ngcontent-sc71]{font-size:20px;font-weight:600;margin-top:20px}.description[_ngcontent-sc71]{margin-top:10px}.banner[_ngcontent-sc71]{width:100%;height:350px;overflow:hidden;margin-top:50px}.banner[_ngcontent-sc71]   img[_ngcontent-sc71]{width:100%;height:100%;object-fit:cover}.credit[_ngcontent-sc71]{display:flex;align-items:center;justify-content:center;flex-wrap:wrap;height:40px;font-size:12px}.credit[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}.credit[_ngcontent-sc71]   a[_ngcontent-sc71]{text-decoration:underline}.contents[_ngcontent-sc71]{position:relative;margin-top:50px}.contents[_ngcontent-sc71]   .container[_ngcontent-sc71]{margin:0}@media screen and (min-width: 841px){.contents[_ngcontent-sc71]{display:flex;align-items:flex-start;flex-wrap:wrap}.contents[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}}@media screen and (max-width: 840px){.contents[_ngcontent-sc71]{display:flex;align-items:center;flex-direction:column-reverse;flex-wrap:wrap}.contents[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}}.actions[_ngcontent-sc71]{box-sizing:border-box;padding:20px 0;position:sticky;top:50px}@media screen and (min-width: 841px){.actions[_ngcontent-sc71]{display:flex;align-items:center;flex-direction:column;flex-wrap:wrap;width:200px}.actions[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}}@media screen and (max-width: 840px){.actions[_ngcontent-sc71]{display:flex;align-items:center;justify-content:center;flex-wrap:wrap;width:100%}.actions[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}}.action[_ngcontent-sc71]{display:flex;align-items:center;flex-direction:column;flex-wrap:wrap;text-align:center;font-size:11px;cursor:pointer;-webkit-user-select:none;user-select:none;text-transform:uppercase}.action[_ngcontent-sc71] > *[_ngcontent-sc71]{flex:0 0 auto}.action[_ngcontent-sc71]   span[_ngcontent-sc71]{margin-top:5px}@media screen and (max-width: 840px){.action[_ngcontent-sc71]   span[_ngcontent-sc71]{display:none}}@media screen and (min-width: 841px){.action[_ngcontent-sc71] + .action[_ngcontent-sc71]{margin-top:20px}}@media screen and (max-width: 840px){.action[_ngcontent-sc71] + .action[_ngcontent-sc71]{margin-left:20px}}article[_ngcontent-sc71]{line-height:1.8em;-webkit-user-select:auto;user-select:auto}app-tag-list[_ngcontent-sc71], app-copyrights[_ngcontent-sc71]{margin-top:50px}app-loading-spinner[_ngcontent-sc71]{position:absolute;width:100%;top:0}</style><style ng-transition="serverApp">[_nghost-sc66]{display:block}.label[_ngcontent-sc66] + .tags[_ngcontent-sc66]{margin-top:10px}.tags[_ngcontent-sc66]{display:flex;flex-wrap:wrap}.tags[_ngcontent-sc66] > *[_ngcontent-sc66]{flex:0 0 auto}a[_ngcontent-sc66]{padding:0 10px;box-sizing:border-box;border:1px solid transparent;display:flex;align-items:center;flex-wrap:wrap;margin-right:5px;margin-bottom:5px;background-color:#41c2de;color:#fff;font-size:12px;height:25px;border-radius:25px}a[_ngcontent-sc66] > *[_ngcontent-sc66]{flex:0 0 auto}a[_ngcontent-sc66]:hover{background-color:#6cd0e6}.empty[_ngcontent-sc66]{width:100%;font-size:12px;text-align:center}</style><style ng-transition="serverApp">[_nghost-sc22]{display:flex;align-items:center;justify-content:center;flex-wrap:wrap;height:55px;text-align:center;font-size:12px}[_nghost-sc22] > *[_ngcontent-sc22]{flex:0 0 auto}</style><style ng-transition="serverApp">[_nghost-sc68]{box-sizing:border-box;padding:20px;display:flex;align-items:flex-start;flex-direction:column;flex-wrap:wrap}[_nghost-sc68] > *[_ngcontent-sc68]{flex:0 0 auto}.light[_nghost-sc68]{background-color:#3333330d}.light[_nghost-sc68]   a[_ngcontent-sc68]   span[_ngcontent-sc68]{color:#3333334d}.dark[_nghost-sc68]{background-color:#ffffff0d}.dark[_nghost-sc68]   a[_ngcontent-sc68]   span[_ngcontent-sc68]{color:#ffffff4d}a[_ngcontent-sc68]{display:block;font-size:12px}a[_ngcontent-sc68]:hover{text-decoration:underline}a.indent-1[_ngcontent-sc68]{box-sizing:border-box;padding-left:0}a.indent-2[_ngcontent-sc68]{box-sizing:border-box;padding-left:10px}a.indent-3[_ngcontent-sc68]{box-sizing:border-box;padding-left:20px}a.indent-4[_ngcontent-sc68]{box-sizing:border-box;padding-left:30px}a.indent-5[_ngcontent-sc68]{box-sizing:border-box;padding-left:40px}a.indent-6[_ngcontent-sc68]{box-sizing:border-box;padding-left:50px}a[_ngcontent-sc68] + a[_ngcontent-sc68]{margin-top:10px}</style><meta property="article:published_time" content="2022-02-19T15:00:00.000Z"><meta property="article:tag" content="Angular"><meta property="article:tag" content="Angular Universal"><meta property="article:tag" content="Http"><meta property="article:tag" content="SSR"><meta property="article:tag" content="Server Side Rendering"><meta property="article:tag" content="twice"><meta property="article:tag" content="api"></head>
<body>
  <app-root _nghost-sc75="" ng-version="13.1.3" class="theme-light"><router-outlet _ngcontent-sc75=""></router-outlet><app-blog _nghost-sc25="" class="ng-star-inserted"><app-header _ngcontent-sc25="" _nghost-sc24=""><div _ngcontent-sc24="" class="container"><a _ngcontent-sc24="" class="title" href="/blog"> LOGLOG </a><div _ngcontent-sc24="" class="buttons"><app-theme-button _ngcontent-sc24="" _nghost-sc21=""><app-icon _ngcontent-sc21="" appripple="" _nghost-sc19="" tk-name="nightlight:black-30" class="tk-ripple-container tk-ripple-black"></app-icon><!----></app-theme-button><a _ngcontent-sc24="" appripple="" class="search tk-ripple-container tk-ripple-black" href="/blog/search"><app-icon _ngcontent-sc24="" name="search:black-30" class="grey-icon" _nghost-sc19="" tk-name="search:black-30"></app-icon></a><!----></div></div></app-header><app-header _ngcontent-sc25="" class="scrollable" _nghost-sc24=""><div _ngcontent-sc24="" class="container"><a _ngcontent-sc24="" class="title" href="/blog"> LOGLOG </a><div _ngcontent-sc24="" class="buttons"><app-theme-button _ngcontent-sc24="" _nghost-sc21=""><app-icon _ngcontent-sc21="" appripple="" _nghost-sc19="" tk-name="nightlight:black-30" class="tk-ripple-container tk-ripple-black"></app-icon><!----></app-theme-button><a _ngcontent-sc24="" appripple="" class="search tk-ripple-container tk-ripple-black" href="/blog/search"><app-icon _ngcontent-sc24="" name="search:black-30" class="grey-icon" _nghost-sc19="" tk-name="search:black-30"></app-icon></a><!----></div></div></app-header><main _ngcontent-sc25="" class=""><div _ngcontent-sc25="" class="container"><router-outlet _ngcontent-sc25=""></router-outlet><app-post _nghost-sc71="" class="ng-tns-c71-0 ng-trigger ng-trigger-fade-in ng-star-inserted" style="opacity:1;"><div _ngcontent-sc71="" class="meta container ng-tns-c71-0"><div _ngcontent-sc71="" class="grey-text ng-tns-c71-0"> 20 February, 2022 </div><h1 _ngcontent-sc71="" class="title ng-tns-c71-0"> How to prevent calling api twice when using Angular Universal? </h1><div _ngcontent-sc71="" class="grey-text description ng-tns-c71-0"> Usage example of TransferState </div></div><div _ngcontent-sc71="" class="banner image-placeholder ng-tns-c71-0"><img _ngcontent-sc71="" class="ng-tns-c71-0 ng-star-inserted" src="/assets/images/posts/2/banner.png" alt="How to prevent calling api twice when using Angular Universal?" style=""><!----></div><div _ngcontent-sc71="" class="credit ng-tns-c71-0 ng-star-inserted" style=""><div _ngcontent-sc71="" class="grey-text ng-tns-c71-0"> Photo by <a _ngcontent-sc71="" appouterlink="" class="ng-tns-c71-0" href="https://unsplash.com/@6heinz3r?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank" rel="nofollow noreferrer noopener">Gabriel Heinzer</a> on <a _ngcontent-sc71="" href="https://unsplash.com" appouterlink="" class="ng-tns-c71-0" target="_blank" rel="nofollow noreferrer noopener">Unsplash</a>. </div></div><!----><div _ngcontent-sc71="" class="contents ng-tns-c71-0"><div _ngcontent-sc71="" class="actions ng-tns-c71-0"><a _ngcontent-sc71="" appouterlink="" class="action ng-tns-c71-0" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Ftk2blog90.github.io%2Fblog%2Fpost%2F2" target="_blank" rel="nofollow noreferrer noopener"><app-icon _ngcontent-sc71="" name="twitter:black-30" class="grey-icon ng-tns-c71-0" _nghost-sc19="" tk-name="twitter:black-30"></app-icon><span _ngcontent-sc71="" class="grey-text ng-tns-c71-0">twitter</span></a><div _ngcontent-sc71="" class="action ng-tns-c71-0"><app-icon _ngcontent-sc71="" name="share:black-30" class="grey-icon ng-tns-c71-0" _nghost-sc19="" tk-name="share:black-30"></app-icon><span _ngcontent-sc71="" class="grey-text ng-tns-c71-0">share</span></div><a _ngcontent-sc71="" href="https://www.buymeacoffee.com/tk2rush90" appouterlink="" class="action ng-tns-c71-0" target="_blank" rel="nofollow noreferrer noopener"><app-icon _ngcontent-sc71="" name="buy-me-a-coffee:black-30" class="grey-icon ng-tns-c71-0" _nghost-sc19="" tk-name="buy-me-a-coffee:black-30"></app-icon><span _ngcontent-sc71="" class="grey-text ng-tns-c71-0">buy me a coffee</span></a></div><article _ngcontent-sc71="" class="container ng-tns-c71-0"><app-table-of-contents _ngcontent-sc71="" _nghost-sc68="" class="ng-tns-c71-0 light ng-star-inserted" style=""><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#prerequisite"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#the-situation"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#why-it-happens"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#to-solve-it-"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#transferstate"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-2 ng-star-inserted" href="/blog/post/2#add-required-modules"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-2 ng-star-inserted" href="/blog/post/2#inject-transferstate"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-2 ng-star-inserted" href="/blog/post/2#create-key-and-getset-state"><span _ngcontent-sc68="">#</span> 
</a><a _ngcontent-sc68="" class="indent-1 ng-star-inserted" href="/blog/post/2#conclusion"><span _ngcontent-sc68="">#</span> 
</a><!----></app-table-of-contents><!----><markdown _ngcontent-sc71="" class="ng-tns-c71-0"><p>The Angular provides powerful support for Server-Side Rendering with Angular Universal.
But when getting some data via HTTP Client, I noticed that
the page calls API twice from the server and browser.
This is the solution to prevent this weirdness.</p>
<h1 id="prerequisite">Prerequisite</h1>
<ul>
<li>Angular2+. I used Angular 13.2.0</li>
<li>Angular Universal. I used <code>@nguniversal/express-engine^13.0.2</code>.</li>
</ul>
<h1 id="the-situation">The situation</h1>
<pre><code class="language-typescript">@Component({
  selector: 'app-get-data',
  templateUrl: './get-data.component.html',
  styleUrls: ['./get-data.component.scss'],
})
export class GetDataComponent implements OnInit {
  loading = false;

  constructor(
    private http: HttpClient,
  ) {
  }

  ngOnInit(): void {
    const sub = this.http.get('{endpoint-to-get-data}')
      .pipe(finalize(() =&gt; this.loading = false))
      .subscribe({
        error: err =&gt; console.error(err),
      });

    this.loading = true;
  }
}
</code></pre>
<p>Imagine that you have the code to get some data by calling API endpoint like above.
If you're not using Angular Universal, the above code doesn't make any issue.
After the component initialized, the <code>loading</code> will be <code>true</code> until the calling API finished.</p>
<p>But if the Angular Universal is used,
the user may see the completed page for a short time at first,
then will encounter the loading indicator for fetching data again.</p>
<h1 id="why-it-happens">Why it happens?</h1>
<p>The Angular is really clever framework and so does Angular Universal.
If there are some API calls when loading the page via server,
the Angular waits until the calling API finished to show completed page.</p>
<p>At that time, the Angular walk through the LifeCycle hooks
from <code>ngOnInit()</code> to <code>ngOnDestory()</code> to create static HTML markups.
After the page loaded, the Angular calls the LifeCycle hooks again
to make the component's functions to be functional.</p>
<p>Since these works create different instances,
the properties will not be shared.</p>
<h1 id="to-solve-it-">To solve it ..</h1>
<p>The solution is simple.
Just let Angular know if page is loaded via server or via browser.
To do this, the Angular provides <code>TransferState</code>.</p>
<h1 id="transferstate">TransferState</h1>
<p>The <code>TransferState</code> is similar with <code>LocalStorage</code>.
But it makes you to keep state between server and browser.</p>
<h2 id="add-required-modules">Add required modules</h2>
<p>Before using <code>TransferState</code> from your component,
you need to import <code>BrowserTransferStateModule</code> and <code>ServerTransferStateModule</code>
to the <code>app.module.ts</code> and <code>app.server.module.ts</code>.</p>
<pre><code class="language-typescript">// app.module.ts
@NgModule({
  declarations: [
    AppComponent
  ],
  imports: [
    BrowserModule.withServerTransition({appId: 'serverApp'}),
    // Import `BrowserTransferStateModule`
    BrowserTransferStateModule,
    AppRoutingModule,
    HttpClientModule,
  ],
  bootstrap: [AppComponent]
})
export class AppModule {
}
</code></pre>
<pre><code class="language-typescript">// app.server.module.ts
@NgModule({
  imports: [
    AppModule,
    ServerModule,
    // Import `ServerTransferStateModule`
    ServerTransferStateModule,
  ],
  bootstrap: [AppComponent],
})
export class AppServerModule {
}
</code></pre>
<h2 id="inject-transferstate">Inject TransferState</h2>
<p>Next, inject the <code>TransferState</code> to your component.</p>
<pre><code class="language-typescript">@Component({
  selector: 'app-get-data',
  templateUrl: './get-data.component.html',
  styleUrls: ['./get-data.component.scss'],
})
export class GetDataComponent implements OnInit {
  loading = false;

  constructor(
    private http: HttpClient,
    // Inject `TransferState`.
    private transferState: TransferState,
  ) {
  }

  ngOnInit(): void {
    const sub = this.http.get('{endpoint-to-get-data}')
      .pipe(finalize(() =&gt; this.loading = false))
      .subscribe({
        error: err =&gt; console.error(err),
      });

    this.loading = true;
  }
}
</code></pre>
<p>You can use following methods for <code>TransferState</code>.
These methods are similar with methods of <code>localStraoge</code>.</p>
<ul>
<li><code>set&lt;T&gt;(key: StateKey&lt;T&gt;, value: T): void</code>.</li>
<li><code>get&lt;T&gt;(key: StateKey&lt;T&gt;, defaultValue: T): T</code>.</li>
<li><code>remove&lt;T&gt;(key: StateKey&lt;T&gt;): void</code>.</li>
</ul>
<p>To see full documentation, check here: <a href="https://angular.io/api/platform-browser/TransferState" target="_blank" rel="nofollow noreferrer noopener">TransferState</a>.</p>
<h2 id="create-key-and-getset-state">Create key and get/set state</h2>
<p>Then create the <code>StateKey</code> with <code>makeStateKey()</code> function.</p>
<pre><code class="language-typescript">const key = makeStateKey('some-key-name');
</code></pre>
<p>You can use this key to set and get data from the <code>TransferState</code> like below.</p>
<pre><code class="language-typescript">@Component({
  selector: 'app-get-data',
  templateUrl: './get-data.component.html',
  styleUrls: ['./get-data.component.scss'],
})
export class GetDataComponent implements OnInit {
  loading = false;

  // Create the key for data which should be shared between server and browser.
  private _key = makeStateKey('data-loaded-state');

  constructor(
    private http: HttpClient,
    private transferState: TransferState,
  ) {
  }

  ngOnInit(): void {
    // Call the API endpoint when data loaded state is not `true`
    if (!this.transferState.get&lt;boolean&gt;(this._key, false)) {
      const sub = this.http.get('{endpoint-to-get-data}')
        .pipe(finalize(() =&gt; {
          this.loading = false;

          // When the API call ended,
          // Set data loaded state as `true` to prevent the browser's API call.
          this.transferState.set&lt;boolean&gt;(this._key, true);
        }))
        .subscribe({
          error: err =&gt; console.error(err),
        });

      this.loading = true;
    }
  }
}
</code></pre>
<p>Now you don't see the duplicated API calls after the server responded.
But it's not the end.
The component can be destroyed and created again by the browser.
In this case, it won't call the API again because the <code>data-loaded-state</code> is still <code>true</code>.</p>
<p>You need to remove the data in key like below when the component to be destroyed.</p>
<pre><code class="language-typescript">@Component({
  selector: 'app-get-data',
  templateUrl: './get-data.component.html',
  styleUrls: ['./get-data.component.scss'],
})
export class GetDataComponent implements OnInit, OnDestroy {
  loading = false;

  private _key = makeStateKey('data-loaded-state');

  constructor(
    private http: HttpClient,
    private transferState: TransferState,
  ) {
  }

  ngOnInit(): void {
    if (!this.transferState.get&lt;boolean&gt;(this._key, false)) {
      const sub = this.http.get('{endpoint-to-get-data}')
        .pipe(finalize(() =&gt; {
          this.loading = false;

          this.transferState.set&lt;boolean&gt;(this._key, true);
        }))
        .subscribe({
          error: err =&gt; console.error(err),
        });

      this.loading = true;
    }
  }

  ngOnDestroy(): void {
    // Remove the key.
    this.transferState.remove&lt;boolean&gt;(this._key);
  }
}
</code></pre>
<p>Then everything works well.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Because it shows just example, I used the loaded state to prevent calling API.
But you can set any data in <code>TransferState</code>, like the response of API call.
It means you can render initial state of the component from the server side.</p>
<p>Hope the Angular gets more popular than React or other frameworks üòÅ</p>
</markdown><app-tag-list _ngcontent-sc71="" class="ng-tns-c71-0" _nghost-sc66=""><div _ngcontent-sc66="" class="label grey-text ng-star-inserted" style=""> Tags
</div><!----><div _ngcontent-sc66="" class="tags"><a _ngcontent-sc66="" ripplecolor="white" appripple="" href="/blog/tags" class="tk-ripple-bounded tk-ripple-container tk-ripple-white ng-star-inserted" style=""> Angular2+ </a><!----><a _ngcontent-sc66="" ripplecolor="white" appripple="" href="/blog/tags" class="tk-ripple-bounded tk-ripple-container tk-ripple-white ng-star-inserted" style=""> Javascript </a><!----><a _ngcontent-sc66="" ripplecolor="white" appripple="" href="/blog/tags" class="tk-ripple-bounded tk-ripple-container tk-ripple-white ng-star-inserted" style=""> Typescript </a><!----><a _ngcontent-sc66="" ripplecolor="white" appripple="" href="/blog/tags" class="tk-ripple-bounded tk-ripple-container tk-ripple-white ng-star-inserted" style=""> SSR </a><!----><!----><!----></div></app-tag-list></article></div><app-copyrights _ngcontent-sc71="" class="ng-tns-c71-0" _nghost-sc22="">Copyright 2022, tk2rush90, All rights reserved
</app-copyrights></app-post><!----></div></main></app-blog><!----><app-toast-outlet _ngcontent-sc75="" _nghost-sc74=""><!----></app-toast-outlet></app-root>
<script src="runtime.981875f5d48baa06.js" type="module"></script><script src="polyfills.1e96b5fb5884ac7d.js" type="module"></script><script src="scripts.4b161fea61748ac4.js" defer=""></script><script src="main.cc5b70d9718a4817.js" type="module"></script>


<script id="serverApp-state" type="application/json">{&q;G.https://tk2blog90.github.io/assets/data/post/2?&q;:{&q;body&q;:{&q;title&q;:&q;How to prevent calling api twice when using Angular Universal?&q;,&q;description&q;:&q;Usage example of TransferState&q;,&q;keywords&q;:[&q;Angular&q;,&q;Angular Universal&q;,&q;Http&q;,&q;SSR&q;,&q;Server Side Rendering&q;,&q;twice&q;,&q;api&q;],&q;tags&q;:[&q;Angular2+&q;,&q;Javascript&q;,&q;Typescript&q;,&q;SSR&q;],&q;banner&q;:&q;/assets/images/posts/2/banner.png&q;,&q;thumbnail&q;:&q;/assets/images/posts/2/thumbnail.png&q;,&q;bannerCredit&q;:{&q;name&q;:&q;Gabriel Heinzer&q;,&q;id&q;:&q;@6heinz3r&q;},&q;publish&q;:&q;2022-02-20 00:00:00&q;,&q;id&q;:&q;2&q;,&q;contents&q;:&q;The Angular provides powerful support for Server-Side Rendering with Angular Universal.\r\nBut when getting some data via HTTP Client, I noticed that\r\nthe page calls API twice from the server and browser.\r\nThis is the solution to prevent this weirdness.\r\n\r\n# Prerequisite\r\n\r\n- Angular2+. I used Angular 13.2.0\r\n- Angular Universal. I used `@nguniversal/express-engine^13.0.2`.\r\n\r\n# The situation\r\n\r\n```typescript\r\n@Component({\r\n  selector: &s;app-get-data&s;,\r\n  templateUrl: &s;./get-data.component.html&s;,\r\n  styleUrls: [&s;./get-data.component.scss&s;],\r\n})\r\nexport class GetDataComponent implements OnInit {\r\n  loading = false;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n  ) {\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    const sub = this.http.get(&s;{endpoint-to-get-data}&s;)\r\n      .pipe(finalize(() =&g; this.loading = false))\r\n      .subscribe({\r\n        error: err =&g; console.error(err),\r\n      });\r\n\r\n    this.loading = true;\r\n  }\r\n}\r\n```\r\n\r\nImagine that you have the code to get some data by calling API endpoint like above.\r\nIf you&s;re not using Angular Universal, the above code doesn&s;t make any issue.\r\nAfter the component initialized, the `loading` will be `true` until the calling API finished.\r\n\r\nBut if the Angular Universal is used,\r\nthe user may see the completed page for a short time at first,\r\nthen will encounter the loading indicator for fetching data again.\r\n\r\n# Why it happens?\r\n\r\nThe Angular is really clever framework and so does Angular Universal.\r\nIf there are some API calls when loading the page via server,\r\nthe Angular waits until the calling API finished to show completed page.\r\n\r\nAt that time, the Angular walk through the LifeCycle hooks\r\nfrom `ngOnInit()` to `ngOnDestory()` to create static HTML markups.\r\nAfter the page loaded, the Angular calls the LifeCycle hooks again\r\nto make the component&s;s functions to be functional.\r\n\r\nSince these works create different instances,\r\nthe properties will not be shared.\r\n\r\n# To solve it ..\r\n\r\nThe solution is simple.\r\nJust let Angular know if page is loaded via server or via browser.\r\nTo do this, the Angular provides `TransferState`.\r\n\r\n# TransferState\r\n\r\nThe `TransferState` is similar with `LocalStorage`.\r\nBut it makes you to keep state between server and browser.\r\n\r\n## Add required modules\r\n\r\nBefore using `TransferState` from your component,\r\nyou need to import `BrowserTransferStateModule` and `ServerTransferStateModule`\r\nto the `app.module.ts` and `app.server.module.ts`.\r\n\r\n```typescript\r\n// app.module.ts\r\n@NgModule({\r\n  declarations: [\r\n    AppComponent\r\n  ],\r\n  imports: [\r\n    BrowserModule.withServerTransition({appId: &s;serverApp&s;}),\r\n    // Import `BrowserTransferStateModule`\r\n    BrowserTransferStateModule,\r\n    AppRoutingModule,\r\n    HttpClientModule,\r\n  ],\r\n  bootstrap: [AppComponent]\r\n})\r\nexport class AppModule {\r\n}\r\n```\r\n\r\n```typescript\r\n// app.server.module.ts\r\n@NgModule({\r\n  imports: [\r\n    AppModule,\r\n    ServerModule,\r\n    // Import `ServerTransferStateModule`\r\n    ServerTransferStateModule,\r\n  ],\r\n  bootstrap: [AppComponent],\r\n})\r\nexport class AppServerModule {\r\n}\r\n```\r\n\r\n## Inject TransferState\r\n\r\nNext, inject the `TransferState` to your component.\r\n\r\n```typescript\r\n@Component({\r\n  selector: &s;app-get-data&s;,\r\n  templateUrl: &s;./get-data.component.html&s;,\r\n  styleUrls: [&s;./get-data.component.scss&s;],\r\n})\r\nexport class GetDataComponent implements OnInit {\r\n  loading = false;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    // Inject `TransferState`.\r\n    private transferState: TransferState,\r\n  ) {\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    const sub = this.http.get(&s;{endpoint-to-get-data}&s;)\r\n      .pipe(finalize(() =&g; this.loading = false))\r\n      .subscribe({\r\n        error: err =&g; console.error(err),\r\n      });\r\n\r\n    this.loading = true;\r\n  }\r\n}\r\n```\r\n\r\nYou can use following methods for `TransferState`.\r\nThese methods are similar with methods of `localStraoge`.\r\n\r\n- `set&l;T&g;(key: StateKey&l;T&g;, value: T): void`.\r\n- `get&l;T&g;(key: StateKey&l;T&g;, defaultValue: T): T`.\r\n- `remove&l;T&g;(key: StateKey&l;T&g;): void`.\r\n\r\nTo see full documentation, check here: [TransferState](https://angular.io/api/platform-browser/TransferState).\r\n\r\n## Create key and get/set state\r\n\r\nThen create the `StateKey` with `makeStateKey()` function.\r\n\r\n```typescript\r\nconst key = makeStateKey(&s;some-key-name&s;);\r\n```\r\n\r\nYou can use this key to set and get data from the `TransferState` like below.\r\n\r\n```typescript\r\n@Component({\r\n  selector: &s;app-get-data&s;,\r\n  templateUrl: &s;./get-data.component.html&s;,\r\n  styleUrls: [&s;./get-data.component.scss&s;],\r\n})\r\nexport class GetDataComponent implements OnInit {\r\n  loading = false;\r\n\r\n  // Create the key for data which should be shared between server and browser.\r\n  private _key = makeStateKey(&s;data-loaded-state&s;);\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private transferState: TransferState,\r\n  ) {\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    // Call the API endpoint when data loaded state is not `true`\r\n    if (!this.transferState.get&l;boolean&g;(this._key, false)) {\r\n      const sub = this.http.get(&s;{endpoint-to-get-data}&s;)\r\n        .pipe(finalize(() =&g; {\r\n          this.loading = false;\r\n\r\n          // When the API call ended,\r\n          // Set data loaded state as `true` to prevent the browser&s;s API call.\r\n          this.transferState.set&l;boolean&g;(this._key, true);\r\n        }))\r\n        .subscribe({\r\n          error: err =&g; console.error(err),\r\n        });\r\n\r\n      this.loading = true;\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nNow you don&s;t see the duplicated API calls after the server responded.\r\nBut it&s;s not the end.\r\nThe component can be destroyed and created again by the browser.\r\nIn this case, it won&s;t call the API again because the `data-loaded-state` is still `true`.\r\n\r\nYou need to remove the data in key like below when the component to be destroyed.\r\n\r\n```typescript\r\n@Component({\r\n  selector: &s;app-get-data&s;,\r\n  templateUrl: &s;./get-data.component.html&s;,\r\n  styleUrls: [&s;./get-data.component.scss&s;],\r\n})\r\nexport class GetDataComponent implements OnInit, OnDestroy {\r\n  loading = false;\r\n\r\n  private _key = makeStateKey(&s;data-loaded-state&s;);\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private transferState: TransferState,\r\n  ) {\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    if (!this.transferState.get&l;boolean&g;(this._key, false)) {\r\n      const sub = this.http.get(&s;{endpoint-to-get-data}&s;)\r\n        .pipe(finalize(() =&g; {\r\n          this.loading = false;\r\n\r\n          this.transferState.set&l;boolean&g;(this._key, true);\r\n        }))\r\n        .subscribe({\r\n          error: err =&g; console.error(err),\r\n        });\r\n\r\n      this.loading = true;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    // Remove the key.\r\n    this.transferState.remove&l;boolean&g;(this._key);\r\n  }\r\n}\r\n```\r\n\r\nThen everything works well.\r\n\r\n# Conclusion\r\n\r\nBecause it shows just example, I used the loaded state to prevent calling API.\r\nBut you can set any data in `TransferState`, like the response of API call.\r\nIt means you can render initial state of the component from the server side.\r\n\r\nHope the Angular gets more popular than React or other frameworks üòÅ\r\n&q;,&q;created&q;:&q;2022-02-20 00:00:00&q;},&q;headers&q;:{&q;connection&q;:[&q;keep-alive&q;],&q;content-length&q;:[&q;8078&q;],&q;server&q;:[&q;GitHub.com&q;],&q;content-type&q;:[&q;application/octet-stream&q;],&q;permissions-policy&q;:[&q;interest-cohort=()&q;],&q;x-origin-cache&q;:[&q;HIT&q;],&q;last-modified&q;:[&q;Mon, 25 Apr 2022 00:43:10 GMT&q;],&q;access-control-allow-origin&q;:[&q;*&q;],&q;strict-transport-security&q;:[&q;max-age=31556952&q;],&q;etag&q;:[&q;\&q;6265ee9e-1f8e\&q;&q;],&q;expires&q;:[&q;Mon, 25 Apr 2022 00:57:39 GMT&q;],&q;cache-control&q;:[&q;max-age=600&q;],&q;x-proxy-cache&q;:[&q;MISS&q;],&q;x-github-request-id&q;:[&q;CFC4:45A7:861304:8EA1F0:6265EFAB&q;],&q;accept-ranges&q;:[&q;bytes&q;],&q;date&q;:[&q;Mon, 25 Apr 2022 00:50:13 GMT&q;],&q;via&q;:[&q;1.1 varnish&q;],&q;age&q;:[&q;154&q;],&q;x-served-by&q;:[&q;cache-icn1450071-ICN&q;],&q;x-cache&q;:[&q;HIT&q;],&q;x-cache-hits&q;:[&q;1&q;],&q;x-timer&q;:[&q;S1650847814.965850,VS0,VE0&q;],&q;vary&q;:[&q;Accept-Encoding&q;],&q;x-fastly-request-id&q;:[&q;20d05ebdb77b93cbedcfa61244a483f1b2d73ac0&q;]},&q;status&q;:200,&q;statusText&q;:&q;OK&q;,&q;url&q;:&q;https://tk2blog90.github.io/assets/data/post/2&q;}}</script></body><!-- This page was prerendered with Angular Universal --></html>